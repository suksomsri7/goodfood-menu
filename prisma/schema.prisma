generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Member {
  id               String            @id @default(cuid())
  lineUserId       String            @unique
  displayName      String?
  pictureUrl       String?
  name             String?
  email            String?
  phone            String?
  gender           String?
  birthDate        DateTime?
  height           Float?
  weight           Float?
  goalWeight       Float?
  goalType         String?
  activityLevel    String?
  dietType         String?
  targetMonths     Int?
  bmr              Float?
  tdee             Float?
  dailyCalories    Int?
  dailyProtein     Float?
  dailyCarbs       Float?
  dailyFat         Float?
  dailySodium      Float?
  dailySugar       Float?
  dailyWater       Float?
  memberTypeId     String?
  isOnboarded      Boolean           @default(false)
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  
  // AI Coach expire date (set by Admin)
  aiCoachExpireDate  DateTime?
  
  // Notification Preferences
  notifyMorningCoach     Boolean   @default(true)
  notifyEveningSummary   Boolean   @default(true)
  notifyWeeklyInsights   Boolean   @default(true)
  notifyLunchSuggestion  Boolean   @default(true)
  notifyDinnerSuggestion Boolean   @default(true)
  notifyWaterReminder    Boolean   @default(true)
  notifyProgressPhoto    Boolean   @default(true)
  notifyPostExercise     Boolean   @default(true)
  notifyWeightReminder   Boolean   @default(true)
  notificationsPausedUntil DateTime?
  
  addresses        Address[]
  aiRecommendation AiRecommendation?
  cartItems        CartItem[]
  exerciseLogs     ExerciseLog[]
  mealLogs         MealLog[]
  memberType       MemberType?       @relation(fields: [memberTypeId], references: [id])
  orders           Order[]
  progressPhotos   ProgressPhoto[]
  waterLogs        WaterLog[]
  weightLogs       WeightLog[]

  @@map("members")
}

model AiRecommendation {
  id           String   @id @default(cuid())
  memberId     String   @unique
  message      String
  context      Json?
  date         DateTime @default(now())
  requestCount Int      @default(1)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  member       Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("ai_recommendations")
}

model MealLog {
  id          String   @id @default(cuid())
  memberId    String
  name        String
  weight      Float?
  multiplier  Float    @default(1)
  calories    Float
  protein     Float
  carbs       Float
  fat         Float
  sodium      Float?
  sugar       Float?
  imageUrl    String?
  ingredients String?
  date        DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  member      Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, date])
  @@map("meal_logs")
}

model WeightLog {
  id        String   @id @default(cuid())
  memberId  String
  weight    Float
  date      DateTime @default(now())
  note      String?
  createdAt DateTime @default(now())
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, date])
  @@map("weight_logs")
}

model WaterLog {
  id        String   @id @default(cuid())
  memberId  String
  amount    Float
  date      DateTime @default(now())
  createdAt DateTime @default(now())
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, date])
  @@map("water_logs")
}

model ExerciseLog {
  id        String   @id @default(cuid())
  memberId  String
  name      String
  type      String?
  duration  Int
  calories  Float
  intensity String?
  note      String?
  date      DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, date])
  @@map("exercise_logs")
}

model CartItem {
  id           String      @id @default(cuid())
  memberId     String
  foodId       String
  restaurantId String?
  quantity     Int         @default(1)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  food         Food        @relation(fields: [foodId], references: [id], onDelete: Cascade)
  member       Member      @relation(fields: [memberId], references: [id], onDelete: Cascade)
  restaurant   Restaurant? @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([memberId, foodId])
  @@map("cart_items")
}

model Address {
  id          String   @id @default(cuid())
  memberId    String
  label       String?
  name        String
  phone       String
  address     String
  subDistrict String?
  district    String?
  province    String
  postalCode  String
  note        String?
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  member      Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  orders      Order[]

  @@index([memberId])
  @@map("addresses")
}

model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique
  memberId        String?
  restaurantId    String?
  addressId       String?
  deliveryName    String?
  deliveryPhone   String?
  deliveryAddress String?
  coursePlan      String?
  totalDays       Int?
  totalPrice      Float       @default(0)
  deliveryFee     Float       @default(0)
  discount        Float       @default(0)
  discountType    String?
  discountValue   Float?
  packageName     String?
  finalPrice      Float?
  status          String      @default("pending")
  note            String?
  trackingNumber  String?
  carrier         String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  items           OrderItem[]
  address         Address?    @relation(fields: [addressId], references: [id])
  member          Member?     @relation(fields: [memberId], references: [id])
  restaurant      Restaurant? @relation(fields: [restaurantId], references: [id])

  @@index([memberId, createdAt])
  @@map("orders")
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  foodId    String
  foodName  String
  price     Float
  quantity  Int     @default(1)
  dayNumber Int?
  mealType  String?
  calories  Float?
  food      Food    @relation(fields: [foodId], references: [id])
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_items")
}

model Restaurant {
  id              String      @id @default(cuid())
  name            String
  slug            String      @unique
  description     String?
  logoUrl         String?
  coverUrl        String?
  sellType        String      @default("both")
  deliveryFee     Float       @default(0)
  deliveryPerMeal Float       @default(0)
  minOrder        Float       @default(0)
  isActive        Boolean     @default(true)
  order           Int         @default(0)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  cartItems       CartItem[]
  categories      Category[]
  foods           Food[]
  orders          Order[]
  packages        Package[]
  promotions      Promotion[]

  @@map("restaurants")
}

model Category {
  id           String      @id @default(cuid())
  name         String
  slug         String      @unique
  description  String?
  color        String      @default("#4CAF50")
  isActive     Boolean     @default(true)
  order        Int         @default(0)
  restaurantId String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  restaurant   Restaurant? @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  foods        Food[]

  @@map("categories")
}

model Food {
  id             String          @id @default(cuid())
  name           String
  description    String?
  ingredients    String[]        @default([])
  imageUrl       String?
  images         String[]        @default([])
  price          Float
  discountPrice  Float?
  badge          String?
  calories       Float
  protein        Float
  carbs          Float
  fat            Float
  fiber          Float?
  sugar          Float?
  sodium         Float?
  servingSize    Float?
  servingUnit    String?
  warning        String?
  isActive       Boolean         @default(true)
  order          Int             @default(0)
  categoryId     String
  restaurantId   String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  cartItems      CartItem[]
  category       Category        @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  restaurant     Restaurant?     @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orderItems     OrderItem[]
  promotionGifts PromotionGift[]
  promotionItems PromotionItem[]

  @@map("foods")
}

model Package {
  id            String      @id @default(cuid())
  name          String
  description   String?
  imageUrl      String?
  days          Int         @default(7)
  mealsPerDay   Int         @default(3)
  requiredItems Int         @default(1)
  price         Float       @default(0)
  discountType  String?     // "percent" | "fixed" | null (optional)
  discountValue Float?      // optional discount value
  freeItems     Int         @default(0) // จำนวนเมนูแถม
  isActive      Boolean     @default(true)
  order         Int         @default(0)
  restaurantId  String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  restaurant    Restaurant? @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@map("packages")
}

model Promotion {
  id            String          @id @default(cuid())
  name          String
  description   String?
  imageUrl      String?
  type          String
  discountType  String?
  discountValue Float?
  minQuantity   Int             @default(1)
  minAmount     Float?
  startDate     DateTime?
  endDate       DateTime?
  isActive      Boolean         @default(true)
  restaurantId  String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  gifts         PromotionGift[]
  items         PromotionItem[]
  restaurant    Restaurant?     @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@map("promotions")
}

model PromotionItem {
  id          String    @id @default(cuid())
  promotionId String
  foodId      String
  quantity    Int       @default(1)
  food        Food      @relation(fields: [foodId], references: [id], onDelete: Cascade)
  promotion   Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  @@unique([promotionId, foodId])
  @@map("promotion_items")
}

model PromotionGift {
  id          String    @id @default(cuid())
  promotionId String
  foodId      String
  quantity    Int       @default(1)
  food        Food      @relation(fields: [foodId], references: [id], onDelete: Cascade)
  promotion   Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  @@unique([promotionId, foodId])
  @@map("promotion_gifts")
}

model ArticleCategory {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  description String?
  color       String    @default("#4CAF50")
  icon        String?
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  articles    Article[]

  @@map("article_categories")
}

model Article {
  id          String           @id @default(cuid())
  title       String
  slug        String           @unique
  excerpt     String?
  content     String?
  imageUrl    String?
  categoryId  String?
  tags        String?
  author      String?
  isFeatured  Boolean          @default(false)
  status      String           @default("draft")
  publishedAt DateTime?
  views       Int              @default(0)
  readTime    Int              @default(5)
  order       Int              @default(0)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  category    ArticleCategory? @relation(fields: [categoryId], references: [id])

  @@map("articles")
}

model Video {
  id          String   @id @default(cuid())
  title       String
  description String?
  youtubeId   String
  thumbnail   String?
  category    String?
  duration    String?
  views       Int      @default(0)
  likes       Int      @default(0)
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("videos")
}

model Staff {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  phone     String?
  avatarUrl String?
  roleId    String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  role      Role     @relation(fields: [roleId], references: [id])

  @@map("staff")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  permissions Json     @default("[]")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  staff       Staff[]

  @@map("roles")
}

model MemberType {
  id                    String   @id @default(cuid())
  name                  String   @unique
  description           String?
  color                 String   @default("#4CAF50")
  dailyPhotoLimit       Int      @default(3)
  dailyAiAnalysisLimit  Int      @default(3)
  dailyAiRecommendLimit Int      @default(3)
  dailyScanLimit        Int      @default(5)
  isDefault             Boolean  @default(false)
  isActive              Boolean  @default(true)
  order                 Int      @default(0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // Course Duration
  courseDuration        Int      @default(7)
  
  // Coaching Times
  morningCoachTime      String   @default("07:00")
  lunchReminderTime     String   @default("11:30")
  dinnerReminderTime    String   @default("17:30")
  eveningSummaryTime    String   @default("20:00")
  
  // Water Reminder
  waterReminderTimes    String   @default("09:00,11:00,14:00,16:00")
  
  // Weekly
  weeklyInsightsTime    String   @default("09:00")
  
  // Inactive threshold (days)
  inactiveReminderDays  Int      @default(2)
  
  members               Member[]

  @@map("member_types")
}

model ProgressPhoto {
  id          String   @id @default(cuid())
  memberId    String
  imageUrl    String
  weight      Float?
  weekNumber  Int
  note        String?
  takenAt     DateTime @default(now())
  createdAt   DateTime @default(now())
  member      Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, weekNumber])
  @@map("progress_photos")
}

model LineConversation {
  id            String        @id @default(cuid())
  lineUserId    String        @unique
  displayName   String?
  pictureUrl    String?
  statusMessage String?
  lastMessageAt DateTime      @default(now())
  unreadCount   Int           @default(0)
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  messages      LineMessage[]

  @@index([lastMessageAt])
  @@map("line_conversations")
}

model LineMessage {
  id               String           @id @default(cuid())
  conversationId   String
  lineMessageId    String?          @unique
  type             String           @default("text")
  direction        String
  content          String?
  stickerPackageId String?
  stickerId        String?
  previewUrl       String?
  fileName         String?
  fileSize         Int?
  duration         Int?
  isRead           Boolean          @default(false)
  createdAt        DateTime         @default(now())
  conversation     LineConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("line_messages")
}

model PaymentAccount {
  id            String   @id @default(cuid())
  bankName      String
  accountName   String
  accountNumber String
  qrCodeUrl     String?
  isActive      Boolean  @default(true)
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("payment_accounts")
}

model BarcodeProduct {
  id          String               @id @default(cuid())
  barcode     String               @unique
  name        String
  brand       String?
  imageUrl    String?
  servingSize Float?
  servingUnit String?              @default("g")
  calories    Float
  protein     Float
  carbs       Float
  fat         Float
  sodium      Float?
  sugar       Float?
  fiber       Float?
  source      String               @default("manual")
  verified    Boolean              @default(false)
  scanCount   Int                  @default(1)
  createdById String?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  scanHistory BarcodeScanHistory[]

  @@index([barcode])
  @@index([name])
  @@map("barcode_products")
}

model BarcodeScanHistory {
  id               String         @id @default(cuid())
  memberId         String
  barcodeProductId String
  quantity         Float          @default(1)
  createdAt        DateTime       @default(now())
  barcodeProduct   BarcodeProduct @relation(fields: [barcodeProductId], references: [id], onDelete: Cascade)

  @@index([memberId, createdAt])
  @@map("barcode_scan_history")
}
