generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== สมาชิก (LINE User) ====================
model Member {
  id            String    @id @default(cuid())
  lineUserId    String    @unique // LINE User ID จาก LIFF
  displayName   String?
  pictureUrl    String?
  name          String? // ชื่อจริง
  email         String?
  phone         String?
  gender        String? // male, female
  birthDate     DateTime?
  height        Float? // cm
  weight        Float? // kg - น้ำหนักปัจจุบัน
  goalWeight    Float? // kg - เป้าหมายน้ำหนัก
  goalType      String? // lose, gain, maintain
  activityLevel String? // sedentary, light, moderate, active, very_active
  dietType      String? // balanced, high_protein, low_fat, custom
  targetMonths  Int? // ระยะเวลาเป้าหมาย (เดือน)
  bmr           Float? // Basal Metabolic Rate
  tdee          Float? // Total Daily Energy Expenditure
  dailyCalories Int? // เป้าหมายแคลอรี่ต่อวัน
  dailyProtein  Float? // เป้าหมายโปรตีนต่อวัน (g)
  dailyCarbs    Float? // เป้าหมายคาร์บต่อวัน (g)
  dailyFat      Float? // เป้าหมายไขมันต่อวัน (g)
  dailySodium   Float? // เป้าหมายโซเดียมต่อวัน (mg)
  dailySugar    Float? // เป้าหมายน้ำตาลต่อวัน (g)
  dailyWater    Float? // เป้าหมายน้ำต่อวัน (ml)
  isOnboarded   Boolean   @default(false) // ผ่านการตั้งค่าเป้าหมายแล้ว
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  mealLogs   MealLog[]
  weightLogs WeightLog[]
  waterLogs  WaterLog[]
  cartItems  CartItem[]
  orders     Order[]

  @@map("members")
}

// ==================== บันทึกมื้ออาหาร ====================
model MealLog {
  id          String   @id @default(cuid())
  memberId    String
  member      Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  name        String
  weight      Float? // กรัม
  multiplier  Float    @default(1) // ตัวคูณ
  calories    Float
  protein     Float
  carbs       Float
  fat         Float
  sodium      Float?
  sugar       Float?
  imageUrl    String?
  ingredients String?
  date        DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([memberId, date])
  @@map("meal_logs")
}

// ==================== บันทึกน้ำหนัก ====================
model WeightLog {
  id        String   @id @default(cuid())
  memberId  String
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  weight    Float
  date      DateTime @default(now())
  note      String?
  createdAt DateTime @default(now())

  @@index([memberId, date])
  @@map("weight_logs")
}

// ==================== บันทึกการดื่มน้ำ ====================
model WaterLog {
  id        String   @id @default(cuid())
  memberId  String
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  amount    Float // ml
  date      DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([memberId, date])
  @@map("water_logs")
}

// ==================== ตะกร้าสินค้า ====================
model CartItem {
  id        String   @id @default(cuid())
  memberId  String
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  foodId    String
  food      Food     @relation(fields: [foodId], references: [id], onDelete: Cascade)
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([memberId, foodId])
  @@map("cart_items")
}

// ==================== คำสั่งซื้อ ====================
model Order {
  id          String      @id @default(cuid())
  orderNumber String      @unique
  memberId    String?
  member      Member?     @relation(fields: [memberId], references: [id], onDelete: SetNull)
  coursePlan  String? // แผนอาหาร
  totalDays   Int? // จำนวนวัน
  totalPrice  Float       @default(0)
  status      String      @default("pending") // pending, confirmed, preparing, ready, completed, cancelled
  note        String?
  items       OrderItem[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([memberId, createdAt])
  @@map("orders")
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  foodId    String
  food      Food    @relation(fields: [foodId], references: [id])
  foodName  String // เก็บชื่อไว้กรณี food ถูกลบ
  price     Float
  quantity  Int     @default(1)
  dayNumber Int? // วันที่ในแผน
  mealType  String? // breakfast, lunch, dinner, snack
  calories  Float?

  @@map("order_items")
}

// ==================== หมวดอาหาร ====================
model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  color       String   @default("#4CAF50")
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  foods       Food[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("categories")
}

// ==================== เมนูอาหาร ====================
model Food {
  id            String   @id @default(cuid())
  name          String
  description   String?
  ingredients   String[] @default([]) // ส่วนประกอบ
  imageUrl      String?
  images        String[] @default([]) // รูปภาพหลายรูป
  price         Float
  discountPrice Float? // ราคาลด
  badge         String? // "discount" | "popular" | "bestseller"
  calories      Float // เปลี่ยนเป็น Float เพื่อรองรับทศนิยม
  protein       Float
  carbs         Float
  fat           Float
  fiber         Float?
  sugar         Float?
  sodium        Float?
  servingSize   Float?
  servingUnit   String?
  warning       String? // คำเตือน เช่น แพ้อาหาร
  isActive      Boolean  @default(true)
  order         Int      @default(0)
  categoryId    String
  category      Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  promotionItems PromotionItem[]
  promotionGifts PromotionGift[]
  cartItems      CartItem[]
  orderItems     OrderItem[]

  @@map("foods")
}

// ==================== แพ็คเกจอาหาร ====================
model Package {
  id            String   @id @default(cuid())
  name          String
  description   String?
  imageUrl      String?
  requiredItems Int      @default(1) // จำนวนรายการที่ต้องซื้อเพื่อรับส่วนลด
  discountType  String   @default("percent") // "percent" | "fixed"
  discountValue Float    @default(0) // ค่าส่วนลด (เป็น % หรือ จำนวนเงิน)
  isActive      Boolean  @default(true)
  order         Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("packages")
}

// ==================== โปรโมชั่น ====================
model Promotion {
  id            String          @id @default(cuid())
  name          String
  description   String?
  imageUrl      String?
  type          String // "discount" | "bundle" | "gift"
  discountType  String? // "percent" | "fixed"
  discountValue Float?
  startDate     DateTime?
  endDate       DateTime?
  isActive      Boolean         @default(true)
  items         PromotionItem[]
  gifts         PromotionGift[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@map("promotions")
}

model PromotionItem {
  id          String    @id @default(cuid())
  promotionId String
  promotion   Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  foodId      String
  food        Food      @relation(fields: [foodId], references: [id], onDelete: Cascade)
  quantity    Int       @default(1)

  @@unique([promotionId, foodId])
  @@map("promotion_items")
}

model PromotionGift {
  id          String    @id @default(cuid())
  promotionId String
  promotion   Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  foodId      String
  food        Food      @relation(fields: [foodId], references: [id], onDelete: Cascade)
  quantity    Int       @default(1)

  @@unique([promotionId, foodId])
  @@map("promotion_gifts")
}

// ==================== บทความ ====================
model Article {
  id        String   @id @default(cuid())
  title     String
  slug      String   @unique
  excerpt   String?
  content   String?  @db.Text
  imageUrl  String?
  category  String?
  status    String   @default("draft") // draft, published
  views     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("articles")
}

// ==================== วีดีโอ ====================
model Video {
  id          String   @id @default(cuid())
  title       String
  description String?
  youtubeId   String
  thumbnail   String?
  category    String?
  duration    String?
  views       Int      @default(0)
  likes       Int      @default(0)
  status      String   @default("active") // active, inactive
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("videos")
}

// ==================== พนักงาน ====================
model Staff {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  phone     String?
  avatarUrl String?
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id])
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("staff")
}

// ==================== สิทธิ์ ====================
model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  permissions Json     @default("[]")
  staff       Staff[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("roles")
}

// ==================== LINE แชท ====================
model LineConversation {
  id              String        @id @default(cuid())
  lineUserId      String        @unique // LINE User ID
  displayName     String?
  pictureUrl      String?
  statusMessage   String?
  lastMessageAt   DateTime      @default(now())
  unreadCount     Int           @default(0)
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  messages        LineMessage[]

  @@index([lastMessageAt])
  @@map("line_conversations")
}

model LineMessage {
  id             String           @id @default(cuid())
  conversationId String
  conversation   LineConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  lineMessageId  String?          @unique // LINE Message ID (null for outgoing)
  type           String           @default("text") // text, image, sticker, video, audio, file
  direction      String           // incoming, outgoing
  content        String?          @db.Text // ข้อความ หรือ URL รูป/ไฟล์
  stickerPackageId String?        // สำหรับ sticker
  stickerId      String?          // สำหรับ sticker
  previewUrl     String?          // preview สำหรับรูป/วีดีโอ
  fileName       String?          // ชื่อไฟล์
  fileSize       Int?             // ขนาดไฟล์
  duration       Int?             // ความยาว audio/video (ms)
  isRead         Boolean          @default(false)
  createdAt      DateTime         @default(now())

  @@index([conversationId, createdAt])
  @@map("line_messages")
}
